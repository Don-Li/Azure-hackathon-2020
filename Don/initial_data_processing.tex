\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Initial Data Processing},
            pdfauthor={Don Li},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
% grffile has become a legacy package: https://ctan.org/pkg/grffile
\IfFileExists{grffile.sty}{%
\usepackage{grffile}
}{}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Initial Data Processing}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Don Li}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{10/06/2020}


\begin{document}
\maketitle

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{library}\NormalTok{( data.table )}
\KeywordTok{library}\NormalTok{( reticulate )}
\KeywordTok{source}\NormalTok{( }\StringTok{"G:/azure_hackathon/data/Don/data_processing_functions.R"}\NormalTok{ )}
\end{Highlighting}
\end{Shaded}

\hypertarget{data-processing-steps}{%
\section{Data processing steps}\label{data-processing-steps}}

\begin{itemize}
\item
  Read the \texttt{.parquet} files. Write out to .RData
\item
  Read the .RData and combine into dataframe
\item
  Remove variables \texttt{bearing} and \texttt{accuracy}
\item
  Convert \texttt{pingtimestamp}
\item
  Add \texttt{weekday}, \texttt{hour}, and \texttt{weekend}. Add
  \texttt{rush\_hour}
\item
  Add distances between GPS pings.
\item
  Filter trips with large jumps between GPS pings.
\end{itemize}

\hypertarget{reding-.parquet}{%
\subsection{\texorpdfstring{Reding
\texttt{.parquet}}{Reding .parquet}}\label{reding-.parquet}}

Read the \texttt{.parquet} files, turn then into an \texttt{R} dataframe
and save them as an \texttt{.RData} file.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source_python}\NormalTok{( }\StringTok{"G:/azure_hackathon/data/Don/read_parquet_function.py"}\NormalTok{ )}

\NormalTok{parquet_files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{( }\DataTypeTok{path =} \StringTok{"G:/azure_hackathon/dataset/"}\NormalTok{,}
    \DataTypeTok{pattern =} \StringTok{".parquet"}\NormalTok{, }\DataTypeTok{full.names =}\NormalTok{ T )}
\KeywordTok{parquet_to_RData}\NormalTok{( parquet_files, }\StringTok{"SNG_part_"}\NormalTok{ )}
\end{Highlighting}
\end{Shaded}

\hypertarget{combine-data-frames}{%
\subsection{Combine data frames}\label{combine-data-frames}}

Read the \texttt{.RData} part files and combine them into a big
dataframe.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rdata_files =}\StringTok{ }\KeywordTok{list.files}\NormalTok{( }\DataTypeTok{path =} \StringTok{"G:/azure_hackathon/dataset/"}\NormalTok{,}
    \DataTypeTok{pattern =} \StringTok{"SNG_part"}\NormalTok{, }\DataTypeTok{full.names =}\NormalTok{ T )}
\NormalTok{all_data =}\StringTok{ }\KeywordTok{combine_RData_part_files}\NormalTok{( rdata_files )}

\KeywordTok{dataset_convert_numeric}\NormalTok{( all_data, }\StringTok{"trj_id"}\NormalTok{ )}

\CommentTok{# Reorder variables}
\KeywordTok{setorder}\NormalTok{( all_data, trj_id, pingtimestamp )}
\end{Highlighting}
\end{Shaded}

\hypertarget{remove-variables}{%
\subsection{Remove variables}\label{remove-variables}}

Remove \texttt{bearing} and \texttt{accuracy} because we probably won't
need to use them for anything.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vars_ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"bearing"}\NormalTok{, }\StringTok{"accuracy"}\NormalTok{, }\StringTok{"driving_mode"}\NormalTok{)}
\KeywordTok{dataset_remove_vars}\NormalTok{( all_data, vars_ )}
\end{Highlighting}
\end{Shaded}

\hypertarget{fill-in-time-variables}{%
\subsection{Fill in time variables}\label{fill-in-time-variables}}

Get \texttt{pingtimestamp}, convert to date format. Add
\texttt{weekday}, \texttt{hour}, and \texttt{weekend}. Add
\texttt{rush\_hour}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dataset_time_vars}\NormalTok{( all_data )}
\CommentTok{# Remove pingtimestamp}
\NormalTok{vars_ =}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"pingtimestamp"}\NormalTok{)}
\KeywordTok{dataset_remove_vars}\NormalTok{( all_data, vars_ )}
\CommentTok{# Add rush_hour}
\KeywordTok{dataset_add_rush_hour}\NormalTok{( all_data )}
\end{Highlighting}
\end{Shaded}

\hypertarget{add-distances}{%
\section{Add distances}\label{add-distances}}

Add path Haversine and reversed Haversine distance. The reversed
Haversine distance swaps longitude for latitude.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{source}\NormalTok{( }\StringTok{"G:/azure_hackathon/data/Don/utility.R"}\NormalTok{ )}
\KeywordTok{dataset_add_distances}\NormalTok{( all_data )}
\end{Highlighting}
\end{Shaded}

There are trips where there is a sudden jump in the GPS location and
then it snaps back on the route. Make a filter to remove this.
Previously, we interpolated these jumps, but when there are 4-5-6-7
pings at random locations, it gets hard. So, just a better use of time
to remove them from the trip.

\hypertarget{algorithm-for-detecting-jumps}{%
\subsubsection{Algorithm for detecting
jumps}\label{algorithm-for-detecting-jumps}}

A jump in the GPS is represented by a large distance between two points,
x1 and x2. If the jump only happens for one GPS sample, then we will see
another large distance between x2 and x3. If there are two GPS samples
out of place, then the large distance will be between x3 and x4.

We just make a filter based on the gap that we want to find the jumps
for. Then we exclude the bad ones.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two_window_threshold =}\StringTok{ }\ControlFlowTok{function}\NormalTok{( x, threshold, }\DataTypeTok{gap =} \DecValTok{1}\NormalTok{ )\{}
\NormalTok{    (x }\OperatorTok{>}\StringTok{ }\NormalTok{threshold) }\OperatorTok{&}\StringTok{ }\NormalTok{(}\KeywordTok{c}\NormalTok{( x[}\OperatorTok{-}\NormalTok{(}\DecValTok{1}\OperatorTok{:}\NormalTok{gap)], }\KeywordTok{rep}\NormalTok{(F,gap) ) }\OperatorTok{>}\StringTok{ }\NormalTok{threshold)}
\NormalTok{\}}

\CommentTok{# Tag trips with jumps smaller than 1km. These are good trips.}
\NormalTok{good_trip_index =}\StringTok{ }\NormalTok{all_data[ , }\KeywordTok{all}\NormalTok{( H_dist }\OperatorTok{<}\StringTok{ }\DecValTok{1}\NormalTok{ ), by =}\StringTok{ "trj_id"}\NormalTok{ ]}
\NormalTok{good_trip_id =}\StringTok{ }\NormalTok{good_trip_index[V1}\OperatorTok{==}\OtherTok{TRUE}\NormalTok{,trj_id]}
\NormalTok{bad_trip_id =}\StringTok{ }\NormalTok{good_trip_index[V1}\OperatorTok{==}\OtherTok{FALSE}\NormalTok{,trj_id]}
\CommentTok{# Check the other trips based on the window filter.}
\NormalTok{good_trips =}\StringTok{ }\NormalTok{all_data[ trj_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{good_trip_id ]}
\NormalTok{bad_trips =}\StringTok{ }\NormalTok{all_data[ trj_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{bad_trip_id ]}

\CommentTok{# Tag GPS samples to remove}
\NormalTok{bad_trips[ , gap_rm }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\NormalTok{F ]}

\NormalTok{gap_seq =}\StringTok{ }\KeywordTok{seq}\NormalTok{( }\DecValTok{1}\NormalTok{, }\DecValTok{120}\NormalTok{ )}
\ControlFlowTok{for}\NormalTok{( gap }\ControlFlowTok{in}\NormalTok{ gap_seq )\{}
    \KeywordTok{cat}\NormalTok{( }\StringTok{"Gap:"}\NormalTok{, gap, }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{ )}
    
    \CommentTok{# Find trips with big GPS gaps}
\NormalTok{    any_gaps =}\StringTok{ }\NormalTok{bad_trips[ , }\KeywordTok{which}\NormalTok{(}\KeywordTok{two_window_threshold}\NormalTok{( H_dist, }\DecValTok{2}\NormalTok{, gap )) , by =}\StringTok{ "trj_id"}\NormalTok{ ]}
\NormalTok{    gap_trips =}\StringTok{ }\KeywordTok{unique}\NormalTok{(any_gaps}\OperatorTok{$}\NormalTok{trj_id)}
    \KeywordTok{cat}\NormalTok{( gap_trips, }\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"}\NormalTok{ )}
    
    \CommentTok{# Tag GPS samples}
\NormalTok{    bad_trips[ trj_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{gap_trips, gap_rm }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\NormalTok{\{}
\NormalTok{        missing_dist =}\StringTok{ }\KeywordTok{which}\NormalTok{( }\KeywordTok{two_window_threshold}\NormalTok{( H_dist, }\DecValTok{2}\NormalTok{, gap ) )}
        \ControlFlowTok{for}\NormalTok{ ( missing }\ControlFlowTok{in}\NormalTok{ missing_dist )\{}
\NormalTok{            neighbours =}\StringTok{ }\NormalTok{missing }\OperatorTok{+}\StringTok{ }\DecValTok{0}\OperatorTok{:}\NormalTok{(gap}\DecValTok{-1}\NormalTok{)}
\NormalTok{            gap_rm[ neighbours ] =}\StringTok{ }\NormalTok{T}
\NormalTok{        \}}
\NormalTok{        gap_rm}
\NormalTok{    \}, by =}\StringTok{ "trj_id"}\NormalTok{ ]}
    
    \CommentTok{# Remove the bad GPS samples}
\NormalTok{    bad_trips =}\StringTok{ }\NormalTok{bad_trips[ gap_rm }\OperatorTok{==}\StringTok{ }\OtherTok{FALSE}\NormalTok{ ]}
    
    \CommentTok{# Compute the distances using the new points}
\NormalTok{    bad_trips[ trj_id }\OperatorTok{%in%}\StringTok{ }\NormalTok{gap_trips, }\KeywordTok{c}\NormalTok{(}\StringTok{"H_dist"}\NormalTok{, }\StringTok{"H_dist2"}\NormalTok{) }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\NormalTok{\{}
\NormalTok{        h_dist =}\StringTok{ }\KeywordTok{haversine}\NormalTok{( rawlat, rawlng )}
\NormalTok{        h1 =}\StringTok{ }\KeywordTok{c}\NormalTok{( }\DecValTok{0}\NormalTok{, h_dist  )}
\NormalTok{        h_dist2 =}\StringTok{ }\KeywordTok{haversine}\NormalTok{( rawlng, rawlat )}
\NormalTok{        h2 =}\StringTok{ }\KeywordTok{c}\NormalTok{( }\DecValTok{0}\NormalTok{, h_dist2 )}
        \KeywordTok{list}\NormalTok{( h1, h2 )}
\NormalTok{    \}, by =}\StringTok{ "trj_id"}\NormalTok{ ]}
\NormalTok{\}}

\CommentTok{# Check distances and make sure they are consistent}
\NormalTok{temp_summary =}\StringTok{ }\NormalTok{bad_trips[ , \{}
\NormalTok{    path_dist =}\StringTok{ }\KeywordTok{sum}\NormalTok{( H_dist )}
\NormalTok{    crow_dist =}\StringTok{ }\KeywordTok{haversine}\NormalTok{( rawlat[}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,.N)], rawlng[}\KeywordTok{c}\NormalTok{(}\DecValTok{1}\NormalTok{,.N)] )}
    \KeywordTok{list}\NormalTok{( }\DataTypeTok{path_dist =}\NormalTok{ path_dist, }\DataTypeTok{crow_dist =}\NormalTok{ crow_dist )}
\NormalTok{\}, by =}\StringTok{ "trj_id"}\NormalTok{ ]}

\NormalTok{temp_summary[ , }\KeywordTok{summary}\NormalTok{(path_dist }\OperatorTok{-}\StringTok{ }\NormalTok{crow_dist) ]}

\CommentTok{# Combine datasets}
\NormalTok{bad_trips[ , gap_rm }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\OtherTok{NULL}\NormalTok{ ]}
\NormalTok{all_data =}\StringTok{ }\KeywordTok{rbindlist}\NormalTok{( }\KeywordTok{list}\NormalTok{( good_trips, bad_trips ), }\DataTypeTok{use.names =}\NormalTok{ T )}
\KeywordTok{setorder}\NormalTok{( all_data, trj_id, date_ )}

\KeywordTok{save}\NormalTok{( all_data, }\DataTypeTok{file =} \StringTok{"G:/azure_hackathon/dataset/all_SNG_1_jump_adjusted.RData"}\NormalTok{ )}
\end{Highlighting}
\end{Shaded}

\hypertarget{add-time-differences}{%
\section{Add time differences}\label{add-time-differences}}

Time difference in seconds between GPS pings.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{dataset_add_timediffs}\NormalTok{( all_data )}
\end{Highlighting}
\end{Shaded}

Add missing values for speed.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{all_data[ osname }\OperatorTok{==}\StringTok{ "android"} \OperatorTok{&}\StringTok{ }\NormalTok{speed }\OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{, speed }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\OtherTok{NaN}\NormalTok{ ]}
\NormalTok{all_data[ speed }\OperatorTok{<}\StringTok{ }\DecValTok{0}\NormalTok{, speed }\OperatorTok{:}\ErrorTok{=}\StringTok{ }\OtherTok{NaN}\NormalTok{ ]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{save}\NormalTok{( all_data, }\DataTypeTok{file =} \StringTok{"G:/azure_hackathon/dataset/all_SNG_2_jump_adjusted.RData"}\NormalTok{ )}
\end{Highlighting}
\end{Shaded}


\end{document}
